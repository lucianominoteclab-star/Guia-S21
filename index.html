<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Asistente Siglo 21</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>

<script type="module">
  import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
  window.CreateMLCEngine = CreateMLCEngine;
</script>

<style>
body { margin:0; font-family:Inter,sans-serif; background:#f4f6f8; display:flex; justify-content:center; height:100vh; }
.app { width:100%; max-width:900px; background:white; display:flex; flex-direction:column; }
header { background:#00953B; color:white; padding:14px 18px; font-weight:600; }
#chat { flex:1; padding:16px; overflow-y:auto; }
.msg { margin-bottom:12px; padding:10px 14px; border-radius:10px; max-width:80%; }
.user { background:#eee; margin-left:auto; }
.bot { background:#e7f4ea; border-left:4px solid #00953B; }
.system { text-align:center; color:#777; font-size:13px; }
footer { display:flex; padding:12px; border-top:1px solid #ddd; gap:10px; }
input { flex:1; padding:12px; border-radius:8px; border:1px solid #ccc; }
button { background:#00953B; color:white; border:none; padding:12px 18px; border-radius:8px; cursor:pointer; }
</style>
</head>

<body>
<div class="app">
<header>Asistente Siglo 21</header>

<div id="chat">
  <div class="system">Cargando base de datosâ€¦</div>
</div>

<footer>
  <input id="q" placeholder="EscribÃ­ tu consultaâ€¦" disabled>
  <button id="send" disabled>Enviar</button>
</footer>
</div>

<script type="module">
const chat = document.getElementById("chat");
const input = document.getElementById("q");
const btn = document.getElementById("send");

function add(text, cls) {
  const d = document.createElement("div");
  d.className = "msg " + cls;
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

let chunks = [];
let idx = null;
let engine = null;

async function init() {
  const txt = await fetch("data/info.txt").then(r=>r.text());

  const parts = txt.split(/\n\n+/).filter(p=>p.length>40);
  chunks = parts.map((t,i)=>({ id:"c"+i, text:t }));

  idx = lunr(function(){
    this.ref("id");
    this.field("text");
    chunks.forEach(d=>this.add(d));
  });

  add("Base cargada. Descargando modelo IAâ€¦", "system");

  engine = await window.CreateMLCEngine(
    "Phi-3.5-mini-instruct-q4f32_1-MLC"
  );

  add("Listo. PodÃ©s preguntar ðŸ‘", "system");
  input.disabled = false;
  btn.disabled = false;
}

async function send() {
  const q = input.value.trim();
  if(!q) return;
  input.value = "";
  add(q,"user");

  const res = idx.search(q).slice(0,3)
    .map(r=>chunks.find(c=>c.id===r.ref).text)
    .join("\n");

  const prompt =
`RespondÃ© solo con esta informaciÃ³n.
Si no figura, decÃ­ que no estÃ¡ en los documentos.

${res}

Pregunta: ${q}`;

  const out = await engine.chat.completions.create({
    messages:[{role:"user",content:prompt}]
  });

  add(out.choices[0].message.content,"bot");
}

btn.onclick = send;
input.onkeydown = e => e.key==="Enter" && send();

init();
</script>

</body>
</html>
