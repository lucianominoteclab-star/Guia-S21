<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Siglo 21 — Rápido</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --green-1: #00953B; --green-2: #026B28; --bg: #f4f7f6; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; height: 100vh; }
    .main-card { background: white; width: 100%; max-width: 800px; height: 95vh; margin-top: 2.5vh; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; }
    
    header { background: var(--green-1); padding: 16px; color: white; display: flex; gap: 12px; align-items: center; }
    .logo { font-weight: 800; font-size: 20px; background: white; color: var(--green-1); padding: 5px 10px; border-radius: 6px; }
    .h-text h1 { margin: 0; font-size: 16px; }
    .h-text p { margin: 0; font-size: 12px; opacity: 0.9; }

    #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
    .msg { max-width: 85%; padding: 12px 16px; border-radius: 10px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
    .msg.user { align-self: flex-end; background: #eef1f5; color: #333; border-bottom-right-radius: 2px; }
    .msg.bot { align-self: flex-start; background: #e6f4ea; color: #0d3d1e; border-bottom-left-radius: 2px; border-left: 4px solid var(--green-1); }
    .msg strong { color: var(--green-2); }
    
    .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
    input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
    input:focus { border-color: var(--green-1); }
    button { background: var(--green-1); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    button:hover { background: var(--green-2); }
    button:disabled { background: #ccc; cursor: not-allowed; }

    /* Spinner de carga */
    .typing { font-size: 12px; color: #888; margin-left: 20px; display: none; font-style: italic; }
  </style>
</head>
<body>

<div class="main-card">
  <header>
    <div class="logo">21</div>
    <div class="h-text">
      <h1>Asistente Académico</h1>
      <p>Consultas rápidas - Modo Cloud</p>
    </div>
  </header>

  <div id="chat-container">
    <div class="msg bot">Hola. El sistema está listo y optimizado. Preguntame lo que necesites sobre la universidad.</div>
  </div>
  <div class="typing" id="typingIndicator">Consultando base de datos...</div>

  <div class="input-area">
    <input id="userIn" type="text" placeholder="Escribí tu pregunta..." autofocus>
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<script>
  // ==========================================
  // 1. CONFIGURACIÓN (PEGÁ TU API KEY ACÁ ABAJO)
  // ==========================================
  const GOOGLE_API_KEY = "AIzaSyBpMvzTe7xqecH_Tb0ChltasNP_za9WfXY"; 
  // ==========================================

  let chunks = [];
  let lunrIndex = null;
  const chatBox = document.getElementById('chat-container');
  const input = document.getElementById('userIn');
  const indicator = document.getElementById('typingIndicator');

  // Cargar datos al iniciar
  window.onload = async () => {
    try {
      const res = await fetch('data/info.txt');
      if(!res.ok) throw new Error("Falta data/info.txt");
      const text = await res.text();
      
      // Cortar texto en pedacitos para buscar rápido
      const raw = text.split(/\n\n+/);
      chunks = raw.map((t,i) => ({id: "id"+i, text: t.trim()})).filter(c=>c.text.length>10);
      
      // Indexar (Buscador local rápido)
      lunrIndex = lunr(function(){
        this.ref('id');
        this.field('text');
        chunks.forEach(function(doc){ this.add(doc) }, this);
      });
      console.log("Sistema cargado: " + chunks.length + " fragmentos.");
    } catch(e) {
      addMsg("Error: No se encontró el archivo de información (data/info.txt).", "bot");
    }
  };

  async function handleSend() {
    const q = input.value.trim();
    if(!q) return;
    
    input.value = '';
    addMsg(q, 'user');
    indicator.style.display = 'block';

    // 1. Búsqueda Local (RAG)
    // Buscamos los 3 fragmentos más parecidos en tu archivo
    const results = lunrIndex.search(q);
    const context = results.slice(0, 4).map(r => chunks.find(c => c.id === r.ref).text).join("\n\n---\n\n");

    // 2. Llamada a la API (Nube)
    // Enviamos el contexto y la pregunta a Google para que redacte
    try {
      const prompt = `
        Actúa como un asesor experto de Universidad Siglo 21.
        Usa SOLO la siguiente información para responder la pregunta del usuario.
        Si la respuesta no está en el texto, di "No tengo información sobre eso en la base de datos."
        
        INFORMACIÓN DE REFERENCIA:
        ${context}

        PREGUNTA DEL USUARIO: "${q}"
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      const data = await response.json();
      const answer = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error al interpretar la respuesta.";
      
      addMsg(marked.parse(answer), 'bot'); // Renderizar Markdown

    } catch(err) {
      addMsg("Error de conexión: " + err.message, 'bot');
    } finally {
      indicator.style.display = 'none';
    }
  }

  function addMsg(html, role) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = html;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.getElementById('sendBtn').onclick = handleSend;
  input.onkeydown = (e) => { if(e.key === 'Enter') handleSend(); };

</script>
</body>
</html>
